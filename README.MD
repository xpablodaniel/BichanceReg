# Proyecto de Registro de Operaciones Crypto en PHP y Mysql

Este proyecto es un ejemplo b√°sico de una aplicaci√≥n web sencilla para registrar operaciones de compra y venta de criptomonedas a trav√©s de un formulario HTML/PHP, almacenando los datos en una base de datos MariaDB/MySQL. Utiliza JavaScript para interactividad en el formulario y demuestra el uso de funciones almacenadas en la base de datos.

\#\# Caracter√≠sticas

\* Formulario web para ingreso de operaciones (Fecha, Par, Tipo, Precio, Cantidad, Fee, Moneda del Fee).  
\* Auto-llenado de Fecha/Hora actual en el formulario.  
\* Auto-llenado de los campos "Base" y "Quote" basado en el campo "Par" (soporta formatos \`BASE/QUOTE\` y \`BASEQUOTE\` si el quote es USDT por defecto).  
\* C√°lculo autom√°tico del "Total" (Precio \\\* Cantidad) en el formulario.  
\* Almacenamiento de datos en una tabla \`operaciones\` en MariaDB/MySQL.  
\* Uso de sentencias preparadas en PHP para una inserci√≥n segura en la base de datos.  
\* Mensaje de confirmaci√≥n de registro exitoso al enviar el formulario.  
\* Configuraci√≥n de conexi√≥n a base de datos externa.  
\* Ejemplo de uso de una Funci√≥n Almacenada para calcular el balance de una divisa.

\#\# Requisitos

\* Servidor Web (como Apache o Nginx) con soporte para PHP.  
\* PHP (versi√≥n 5.6 o superior recomendada, compatible con \`mysqli\`).  
\* Servidor de Base de Datos MariaDB o MySQL.

\#\# Estructura del Proyecto

La estructura de archivos del proyecto es la siguiente:  
/tu\_proyecto/   
‚îú‚îÄ‚îÄ index.php \# Archivo principal con el formulario HTML y l√≥gica PHP para mostrar mensajes.   
‚îú‚îÄ‚îÄ procesar.php \# Archivo PHP para procesar los datos del formulario e insertar en la DB. ‚îú‚îÄ‚îÄ script.js \# Archivo JavaScript para la interactividad del formulario (fechas, c√°lculo, parsing de par).  
‚îú‚îÄ‚îÄ style.css \# Archivo CSS para dar estilos b√°sicos al formulario.   
‚îî‚îÄ‚îÄ config.php \# Archivo PHP con la configuraci√≥n de conexi√≥n a la base de datos.

\#\# Configuraci√≥n y Puesta en Marcha \#\#\#   
1\. Configuraci√≥n de la Base de Datos MariaDB/MySQL Primero, necesitas crear la base de datos y la tabla \`operaciones\`. Con√©ctate a tu servidor MariaDB/MySQL (usando la l√≠nea de comandos \`mysql\` o una herramienta gr√°fica como phpMyAdmin, Adminer, DBeaver, etc.) y ejecuta las siguientes sentencias SQL: 

\`\`\`sql  
 \-- Crear la base de datos (si no existe)  
CREATE DATABASE IF NOT EXISTS Bichance;  
 \-- Usar la base de datos USE Bichance;  
 \-- Crear la tabla 'operaciones' CREATE TABLE IF NOT EXISTS operaciones (  
id INT AUTO\_INCREMENT PRIMARY KEY,   
fecha TEXT,  \-- Considerar cambiar a DATETIME o TIMESTAMP en un proyecto m√°s robusto   
par VARCHAR(255),   
base VARCHAR(255),  
 quote VARCHAR(255),  
 tipo VARCHAR(255), \-- BUY o SELL  
 precio DOUBLE,   
cantidad DOUBLE,  
 total DOUBLE,  
 fee DOUBLE,   
moneda\_fee VARCHAR(255)  
 );  
 \-- Opcional pero recomendado para mejorar el rendimiento en consultas por 'base' o 'tipo' CREATE INDEX idx\_operaciones\_base ON operaciones (base);  
CREATE INDEX idx\_operaciones\_tipo ON operaciones (tipo);  
 \-- Si consultas mucho por base Y tipo, un √≠ndice compuesto podr√≠a ser √∫til  
 \-- CREATE INDEX idx\_operaciones\_base\_tipo ON operaciones (base, tipo);  
\`\`\`

¬°Excelente\! Me parece una gran idea documentar este proyecto colaborativo en un archivo README.md. Ser√° muy √∫til para ti como referencia y para compartir si alguien m√°s quiere aprender o utilizarlo.

Aqu√≠ tienes el contenido completo para tu archivo `README.md`, incluyendo la estructura del proyecto, el c√≥digo de cada archivo, la configuraci√≥n de la base de datos y la funci√≥n almacenada, as√≠ como el documento sobre Stored Procedures y Prepared Statements.

Markdown  
\# Proyecto Simple de Registro de Operaciones Crypto en PHP y MariaDB

Este proyecto es un ejemplo b√°sico de una aplicaci√≥n web sencilla para registrar operaciones de compra y venta de criptomonedas a trav√©s de un formulario HTML/PHP, almacenando los datos en una base de datos MariaDB/MySQL. Utiliza JavaScript para interactividad en el formulario y demuestra el uso de funciones almacenadas en la base de datos.

\#\# Caracter√≠sticas

\* Formulario web para ingreso de operaciones (Fecha, Par, Tipo, Precio, Cantidad, Fee, Moneda del Fee).  
\* Auto-llenado de Fecha/Hora actual en el formulario.  
\* Auto-llenado de los campos "Base" y "Quote" basado en el campo "Par" (soporta formatos \`BASE/QUOTE\` y \`BASEQUOTE\` si el quote es USDT por defecto).  
\* C√°lculo autom√°tico del "Total" (Precio \\\* Cantidad) en el formulario.  
\* Almacenamiento de datos en una tabla \`operaciones\` en MariaDB/MySQL.  
\* Uso de sentencias preparadas en PHP para una inserci√≥n segura en la base de datos.  
\* Mensaje de confirmaci√≥n de registro exitoso al enviar el formulario.  
\* Configuraci√≥n de conexi√≥n a base de datos externa.  
\* Ejemplo de uso de una Funci√≥n Almacenada para calcular el balance de una divisa.

\#\# Requisitos

\* Servidor Web (como Apache o Nginx) con soporte para PHP.  
\* PHP (versi√≥n 5.6 o superior recomendada, compatible con \`mysqli\`).  
\* Servidor de Base de Datos MariaDB o MySQL.

\#\# Estructura del Proyecto

La estructura de archivos del proyecto es la siguiente:

/tu\_proyecto/ ‚îú‚îÄ‚îÄ index.php \# Archivo principal con el formulario HTML y l√≥gica PHP para mostrar mensajes. ‚îú‚îÄ‚îÄ procesar.php \# Archivo PHP para procesar los datos del formulario e insertar en la DB. ‚îú‚îÄ‚îÄ script.js \# Archivo JavaScript para la interactividad del formulario (fechas, c√°lculo, parsing de par). ‚îú‚îÄ‚îÄ style.css \# Archivo CSS para dar estilos b√°sicos al formulario. ‚îî‚îÄ‚îÄ config.php \# Archivo PHP con la configuraci√≥n de conexi√≥n a la base de datos.

\#\# Configuraci√≥n y Puesta en Marcha

### **1\. Configuraci√≥n de la Base de Datos MariaDB/MySQL**

Primero, necesitas crear la base de datos y la tabla \`operaciones\`. Con√©ctate a tu servidor MariaDB/MySQL (usando la l√≠nea de comandos \`mysql\` o una herramienta gr√°fica como phpMyAdmin, Adminer, DBeaver, etc.) y ejecuta las siguientes sentencias SQL:

\`\`\`sql  
\-- Crear la base de datos (si no existe)  
CREATE DATABASE IF NOT EXISTS Bichance;

\-- Usar la base de datos  
USE Bichance;

\-- Crear la tabla 'operaciones'  
CREATE TABLE IF NOT EXISTS operaciones (  
    id INT AUTO\_INCREMENT PRIMARY KEY,  
    fecha TEXT, \-- Considerar cambiar a DATETIME o TIMESTAMP en un proyecto m√°s robusto  
    par VARCHAR(255),  
    base VARCHAR(255),  
    quote VARCHAR(255),  
    tipo VARCHAR(255), \-- BUY o SELL  
    precio DOUBLE,  
    cantidad DOUBLE,  
    total DOUBLE,  
    fee DOUBLE,  
    moneda\_fee VARCHAR(255)  
);

\-- Opcional pero recomendado para mejorar el rendimiento en consultas por 'base' o 'tipo'  
CREATE INDEX idx\_operaciones\_base ON operaciones (base);  
CREATE INDEX idx\_operaciones\_tipo ON operaciones (tipo);  
\-- Si consultas mucho por base Y tipo, un √≠ndice compuesto podr√≠a ser √∫til  
\-- CREATE INDEX idx\_operaciones\_base\_tipo ON operaciones (base, tipo);  
\`\`\`

**Nota sobre Permisos de Creaci√≥n:**

La creaci√≥n de la base de datos, tablas, √≠ndices y funciones almacenadas requiere permisos suficientes en el servidor MariaDB/MySQL. T√≠picamente, el usuario `root` tiene estos permisos. Si usas otro usuario, aseg√∫rate de que tenga los privilegios `CREATE DATABASE`, `CREATE TABLE`, `CREATE INDEX`, `CREATE ROUTINE`, etc., sobre la base de datos `Bichance`.

### **2\. Configuraci√≥n de Conexi√≥n (`config.php`)**

Edita el archivo `config.php` con los detalles de tu conexi√≥n a la base de datos:

\`\`\`php

\<?php

$host \= 'localhost'; // O la IP/nombre del servidor de la DB

$user \= 'pablo';     // Tu usuario de base de datos

$password \= 'usuario'; // Tu contrase√±a de base de datos

$database \= 'Bichance'; // El nombre de la base de datos que creaste

$conn \= @new mysqli($host, $user, $password, $database);

// Verificar errores de conexi√≥n

if ($conn-\>connect\_error) {

    // En un entorno de producci√≥n, es mejor no mostrar detalles del error al usuario final

    die('‚ùå Conexi√≥n fallida: (' . $conn-\>connect\_errno . ') ' . $conn-\>connect\_error);

} else {

    // Opcional: para verificar conexi√≥n exitosa (comentar o eliminar en producci√≥n)

    // echo '‚úÖ Conexi√≥n exitosa a la base de datos.';

}

?\>

\`\`\`

Reemplaza `'localhost'`, `'pablo'`, `'usuario'` y `'Bichance'` con tus datos de conexi√≥n.

### **3\. Archivos del Proyecto**

Coloca los archivos `index.php`, `procesar.php`, `script.js`, `style.css` y `config.php` dentro de un directorio en tu servidor web (por ejemplo, `htdocs/bichance/` si usas XAMPP/Apache).

### **4\. Crear la Funci√≥n Almacenada (Opcional pero Recomendado)**

Como discutimos, una forma √∫til de consultar el balance de una divisa es usando una funci√≥n almacenada. Puedes crearla ejecutando el siguiente c√≥digo SQL en tu base de datos `Bichance`:

\`\`\`sql  
USE Bichance;

DELIMITER $$ \-- Cambiamos el delimitador temporalmente

CREATE FUNCTION calcular\_balance\_divisa (divisa\_base VARCHAR(255))  
RETURNS DOUBLE \-- Indicamos que la funci√≥n devolver√° un valor de tipo DOUBLE  
READS SQL DATA \-- Indica que la funci√≥n solo lee datos de las tablas  
BEGIN  
    DECLARE balance DOUBLE; \-- Declaramos una variable para almacenar el resultado

    \-- Calculamos la suma condicional (BUYs positivos, SELLs negativos)  
    SELECT SUM(case when tipo \= 'BUY' THEN cantidad when tipo \= 'SELL' THEN \-cantidad else 0 END)  
    INTO balance \-- Guardamos el resultado de la suma en la variable 'balance'  
    FROM operaciones  
    WHERE base \= divisa\_base; \-- Filtramos por la divisa\_base que recibimos como par√°metro

    RETURN balance; \-- Devolvemos el valor calculado  
END$$

DELIMITER ; \-- Restauramos el delimitador original

\`\`\`

¬°Excelente\! Me parece una gran idea documentar este proyecto colaborativo en un archivo README.md. Ser√° muy √∫til para ti como referencia y para compartir si alguien m√°s quiere aprender o utilizarlo.

Aqu√≠ tienes el contenido completo para tu archivo `README.md`, incluyendo la estructura del proyecto, el c√≥digo de cada archivo, la configuraci√≥n de la base de datos y la funci√≥n almacenada, as√≠ como el documento sobre Stored Procedures y Prepared Statements.

Markdown  
\# Proyecto Simple de Registro de Operaciones Crypto en PHP y MariaDB

Este proyecto es un ejemplo b√°sico de una aplicaci√≥n web sencilla para registrar operaciones de compra y venta de criptomonedas a trav√©s de un formulario HTML/PHP, almacenando los datos en una base de datos MariaDB/MySQL. Utiliza JavaScript para interactividad en el formulario y demuestra el uso de funciones almacenadas en la base de datos.

\#\# Caracter√≠sticas

\* Formulario web para ingreso de operaciones (Fecha, Par, Tipo, Precio, Cantidad, Fee, Moneda del Fee).  
\* Auto-llenado de Fecha/Hora actual en el formulario.  
\* Auto-llenado de los campos "Base" y "Quote" basado en el campo "Par" (soporta formatos \`BASE/QUOTE\` y \`BASEQUOTE\` si el quote es USDT por defecto).  
\* C√°lculo autom√°tico del "Total" (Precio \\\* Cantidad) en el formulario.  
\* Almacenamiento de datos en una tabla \`operaciones\` en MariaDB/MySQL.  
\* Uso de sentencias preparadas en PHP para una inserci√≥n segura en la base de datos.  
\* Mensaje de confirmaci√≥n de registro exitoso al enviar el formulario.  
\* Configuraci√≥n de conexi√≥n a base de datos externa.  
\* Ejemplo de uso de una Funci√≥n Almacenada para calcular el balance de una divisa.

\#\# Requisitos

\* Servidor Web (como Apache o Nginx) con soporte para PHP.  
\* PHP (versi√≥n 5.6 o superior recomendada, compatible con \`mysqli\`).  
\* Servidor de Base de Datos MariaDB o MySQL.

\#\# Estructura del Proyecto

La estructura de archivos del proyecto es la siguiente:

/tu\_proyecto/ ‚îú‚îÄ‚îÄ index.php \# Archivo principal con el formulario HTML y l√≥gica PHP para mostrar mensajes. ‚îú‚îÄ‚îÄ procesar.php \# Archivo PHP para procesar los datos del formulario e insertar en la DB. ‚îú‚îÄ‚îÄ script.js \# Archivo JavaScript para la interactividad del formulario (fechas, c√°lculo, parsing de par). ‚îú‚îÄ‚îÄ style.css \# Archivo CSS para dar estilos b√°sicos al formulario. ‚îî‚îÄ‚îÄ config.php \# Archivo PHP con la configuraci√≥n de conexi√≥n a la base de datos.

\#\# Configuraci√≥n y Puesta en Marcha

\#\#\# 1\. Configuraci√≥n de la Base de Datos MariaDB/MySQL

Primero, necesitas crear la base de datos y la tabla \`operaciones\`. Con√©ctate a tu servidor MariaDB/MySQL (usando la l√≠nea de comandos \`mysql\` o una herramienta gr√°fica como phpMyAdmin, Adminer, DBeaver, etc.) y ejecuta las siguientes sentencias SQL:

\`\`\`sql  
\-- Crear la base de datos (si no existe)  
CREATE DATABASE IF NOT EXISTS Bichance;

\-- Usar la base de datos  
USE Bichance;

\-- Crear la tabla 'operaciones'  
CREATE TABLE IF NOT EXISTS operaciones (  
    id INT AUTO\_INCREMENT PRIMARY KEY,  
    fecha TEXT, \-- Considerar cambiar a DATETIME o TIMESTAMP en un proyecto m√°s robusto  
    par VARCHAR(255),  
    base VARCHAR(255),  
    quote VARCHAR(255),  
    tipo VARCHAR(255), \-- BUY o SELL  
    precio DOUBLE,  
    cantidad DOUBLE,  
    total DOUBLE,  
    fee DOUBLE,  
    moneda\_fee VARCHAR(255)  
);

\-- Opcional pero recomendado para mejorar el rendimiento en consultas por 'base' o 'tipo'  
CREATE INDEX idx\_operaciones\_base ON operaciones (base);  
CREATE INDEX idx\_operaciones\_tipo ON operaciones (tipo);  
\-- Si consultas mucho por base Y tipo, un √≠ndice compuesto podr√≠a ser √∫til  
\-- CREATE INDEX idx\_operaciones\_base\_tipo ON operaciones (base, tipo);

**Nota sobre Permisos de Creaci√≥n:**

La creaci√≥n de la base de datos, tablas, √≠ndices y funciones almacenadas requiere permisos suficientes en el servidor MariaDB/MySQL. T√≠picamente, el usuario `root` tiene estos permisos. Si usas otro usuario, aseg√∫rate de que tenga los privilegios `CREATE DATABASE`, `CREATE TABLE`, `CREATE INDEX`, `CREATE ROUTINE`, etc., sobre la base de datos `Bichance`.

### **2\. Configuraci√≥n de Conexi√≥n (`config.php`)**

Edita el archivo `config.php` con los detalles de tu conexi√≥n a la base de datos:

\`\`\`PHP  
\<?php  
$host \= 'localhost'; // O la IP/nombre del servidor de la DB  
$user \= 'pablo';     // Tu usuario de base de datos  
$password \= 'usuario'; // Tu contrase√±a de base de datos  
$database \= 'Bichance'; // El nombre de la base de datos que creaste

$conn \= @new mysqli($host, $user, $password, $database);

// Verificar errores de conexi√≥n  
if ($conn-\>connect\_error) {  
    // En un entorno de producci√≥n, es mejor no mostrar detalles del error al usuario final  
    die('‚ùå Conexi√≥n fallida: (' . $conn-\>connect\_errno . ') ' . $conn-\>connect\_error);  
} else {  
    // Opcional: para verificar conexi√≥n exitosa (comentar o eliminar en producci√≥n)  
    // echo '‚úÖ Conexi√≥n exitosa a la base de datos.';  
}  
?\>  
\`\`\`

Reemplaza `'localhost'`, `'pablo'`, `'usuario'` y `'Bichance'` con tus datos de conexi√≥n.

### **3\. Archivos del Proyecto**

Coloca los archivos `index.php`, `procesar.php`, `script.js`, `style.css` y `config.php` dentro de un directorio en tu servidor web (por ejemplo, `htdocs/bichance/` si usas XAMPP/Apache).

### **4\. Crear la Funci√≥n Almacenada (Opcional pero Recomendado)**

Como discutimos, una forma √∫til de consultar el balance de una divisa es usando una funci√≥n almacenada. Puedes crearla ejecutando el siguiente c√≥digo SQL en tu base de datos `Bichance`:

\`\`\`SQL  
USE Bichance;

DELIMITER $$ \-- Cambiamos el delimitador temporalmente

CREATE FUNCTION calcular\_balance\_divisa (divisa\_base VARCHAR(255))  
RETURNS DOUBLE \-- Indicamos que la funci√≥n devolver√° un valor de tipo DOUBLE  
READS SQL DATA \-- Indica que la funci√≥n solo lee datos de las tablas  
BEGIN  
    DECLARE balance DOUBLE; \-- Declaramos una variable para almacenar el resultado

    \-- Calculamos la suma condicional (BUYs positivos, SELLs negativos)  
    SELECT SUM(case when tipo \= 'BUY' THEN cantidad when tipo \= 'SELL' THEN \-cantidad else 0 END)  
    INTO balance \-- Guardamos el resultado de la suma en la variable 'balance'  
    FROM operaciones  
    WHERE base \= divisa\_base; \-- Filtramos por la divisa\_base que recibimos como par√°metro

    RETURN balance; \-- Devolvemos el valor calculado  
END$$

DELIMITER ; \-- Restauramos el delimitador original  
\`\`\`

Una vez creada, puedes consultar el balance de una divisa (ej: BCH) ejecutando `SELECT calcular_balance_divisa('BCH');` en tu cliente SQL.

## **Uso**

1. Abre tu navegador web y navega a la URL donde desplegaste el proyecto (ej: `http://localhost/bichance/` o `http://tu_dominio/bichance/`).  
2. Ver√°s el formulario de registro de operaciones.  
3. Llena los campos. Al ingresar el "Par" (ej: `ETH/USDT`), los campos "Base" (ETH) y "Quote" (USDT) se auto-llenar√°n. Al ingresar "Precio" y "Cantidad", el campo "Total" se calcular√° autom√°ticamente.  
4. Haz clic en el bot√≥n "Registrar".  
5. Si la operaci√≥n se registra con √©xito, ser√°s redirigido a `index.php` y ver√°s el mensaje de √©xito en la parte superior de la p√°gina. Si falla, ver√°s un mensaje de error.

## **C√≥digo de los Archivos**

Aqu√≠ se incluye el c√≥digo completo de cada archivo del proyecto para referencia:

### **`index.php`**

\`\`\`php  
\<\!DOCTYPE html\>  
\<html lang="es"\>  
\<head\>  
    \<meta charset="UTF-8"\>  
    \<meta name="viewport" content="width=device-width, initial-scale=1.0"\>  
    \<title\>Registrar Operaci√≥n\</title\>  
    \<link rel="stylesheet" href="style.css"\>  
    \<script src="script.js" defer\>\</script\>  
\</head\>  
\<body\>  
    \<h1\>Ingreso de Operaci√≥n Crypto\</h1\>

    \<?php  
    // Verifica si el par√°metro 'mensaje' existe en la URL y si su valor es 'ok'  
    if (isset($\_GET\['mensaje'\]) && $\_GET\['mensaje'\] \== 'ok') {  
    ?\>  
        \<div style="color: green; font-weight: bold; margin-bottom: 10px;"\>  
            ‚úÖ Operaci√≥n registrada con √©xito  
        \</div\>  
    \<?php  
    }  
    // Si quisieras mostrar errores pasados por URL, podr√≠as a√±adir otro 'if' aqu√≠:  
    // if (isset($\_GET\['mensaje'\]) && $\_GET\['mensaje'\] \== 'error') { ... }  
    ?\>

    \<form action="procesar.php" method="post" id="formularioOperacion"\>  
        \<label\>Fecha: \<input type="datetime-local" name="fecha" id="fecha" required\>\</label\>

        \<label\>Par: \<input type="text" name="par" id="par" required placeholder="Ej: BTC/USDT o BTCUSDT"\>\</label\>

        \<label\>Base: \<input type="text" name="base" id="base" required readonly\>\</label\>  
        \<label\>Quote: \<input type="text" name="quote" id="quote" value="USDT" required readonly\>\</label\>

        \<label\>Tipo:  
            \<select name="tipo" id="tipo" required\>  
                \<option value="BUY"\>Compra\</option\>  
                \<option value="SELL"\>Venta\</option\>  
            \</select\>  
        \</label\>

        \<label\>Precio: \<input type="number" step="0.00000001" name="precio" id="precio" required\>\</label\>  
        \<label\>Cantidad: \<input type="number" step="0.00000001" name="cantidad" id="cantidad" required\>\</label\>

        \<label\>Total: \<input type="number" step="0.00000001" name="total" id="total" required readonly\>\</label\>  
        \<label\>Fee: \<input type="number" step="0.00000001" name="fee" id="fee" value="0.00001969" required\>\</label\>

        \<label\>Moneda del Fee: \<input type="text" name="moneda\_fee" id="moneda\_fee" value="BNB" required readonly\>\</label\>  
        \<button type="submit"\>Registrar\</button\>  
    \</form\>

    \<div id="messages"\>\</div\>

\</body\>  
\</html\>

\`\`\`

### **`procesar.php`**

\`\`\`php  
\<?php  
require 'config.php';

// Funci√≥n para limpiar y escapar datos (b√°sico, considera usar m√°s robustos si es necesario)  
function limpiar($valor) {  
    // Elimina espacios al inicio y final, y convierte caracteres especiales a entidades HTML  
    return htmlspecialchars(trim($valor));  
}

$campos \= \['fecha', 'par', 'base', 'quote', 'tipo', 'precio', 'cantidad', 'total', 'fee', 'moneda\_fee'\];  
$datos \= \[\];

// Validar y limpiar campos POST  
foreach ($campos as $campo) {  
    if (\!isset($\_POST\[$campo\]) || $\_POST\[$campo\] \=== '') {  
        // Si falta alg√∫n campo, muestra un error y detiene la ejecuci√≥n  
        die("Error: Falta completar el campo: " . htmlspecialchars($campo));  
    }  
    $datos\[$campo\] \= limpiar($\_POST\[$campo\]);  
}

// üîÅ Correcci√≥n de formato de fecha si viene de input\[type="datetime-local"\] (reemplaza 'T' por un espacio)  
$datos\['fecha'\] \= str\_replace('T', ' ', $datos\['fecha'\]);

// üîÅ Redondear valores num√©ricos a una precisi√≥n adecuada antes de insertar  
// Esto ayuda a evitar problemas de precisi√≥n flotante en la base de datos y al mostrar  
// Se usan floatval() para asegurar que los datos sean tratados como n√∫meros  
$datos\['precio'\] \= round(floatval($datos\['precio'\]), 8); // Usar una precisi√≥n mayor para precios/cantidades  
$datos\['cantidad'\] \= round(floatval($datos\['cantidad'\]), 8);  
$datos\['total'\] \= round(floatval($datos\['total'\]), 8);  
$datos\['fee'\] \= round(floatval($datos\['fee'\]), 8);

// Preparar la sentencia SQL para insertar datos  
// Se usan placeholders (?) para prevenir inyecciones SQL  
$stmt \= $conn-\>prepare("INSERT INTO operaciones (fecha, par, base, quote, tipo, precio, cantidad, total, fee, moneda\_fee)  
                         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");

// Verificar si la preparaci√≥n de la sentencia fue exitosa  
if ($stmt \=== false) {  
    // Muestra un error si la preparaci√≥n falla  
    die("Error en la preparaci√≥n de la sentencia: " . $conn-\>error);  
}

// Vincular los par√°metros con los valores limpios de los datos POST  
// La cadena "sssssdddds" especifica los tipos de datos de los par√°metros:  
// s \= string, d \= double (o float/decimal), i \= integer, b \= blob  
$stmt-\>bind\_param("ssssddddds",  
    $datos\['fecha'\],  
    $datos\['par'\],  
    $datos\['base'\],  
    $datos\['quote'\],  
    $datos\['tipo'\],  
    $datos\['precio'\],  
    $datos\['cantidad'\],  
    $datos\['total'\],  
    $datos\['fee'\],  
    $datos\['moneda\_fee'\]  
);

// Ejecutar la sentencia preparada  
if ($stmt-\>execute()) {  
    // Si la ejecuci√≥n es exitosa, redirigir a index.php con un mensaje de √©xito  
    // El par√°metro 'mensaje=ok' ser√° le√≠do por index.php  
    header("Location: index.php?mensaje=ok");  
    exit(); // Importante terminar el script despu√©s de una redirecci√≥n  
} else {  
    // Si la ejecuci√≥n falla, muestra un mensaje de error  
    // Considera redirigir tambi√©n con un par√°metro de error para consistencia  
    echo "\<h2\>‚ùå Error al insertar la operaci√≥n: " . $stmt-\>error . "\</h2\>";  
    // Opcional: Redirigir con error \-\> header("Location: index.php?mensaje=error\&detalle=" . urlencode($stmt-\>error)); exit();  
}

// Cerrar la sentencia y la conexi√≥n a la base de datos  
$stmt-\>close();  
$conn-\>close();  
?\>  
Nota: He a√±adido `round(floatval(...), 8)` a los campos num√©ricos en `procesar.php` para manejar mejor la precisi√≥n de los puntos flotantes antes de la inserci√≥n, lo cual es una buena pr√°ctica.

\`\`\`

### **`script.js`**

\`\`\`Javascript

document.addEventListener('DOMContentLoaded', function() {  
    // \--- 1\. Establecer la fecha y hora actual \---  
    const fechaInput \= document.getElementById('fecha');  
    if (fechaInput) {  
        const now \= new Date();  
        // Formato\<ctrl97\>-MM-DDTHH:MM requerido por input type="datetime-local"  
        const year \= now.getFullYear();  
        const month \= (now.getMonth() \+ 1).toString().padStart(2, '0'); // getMonth() es base 0  
        const day \= now.getDate().toString().padStart(2, '0');  
        const hours \= now.getHours().toString().padStart(2, '0');  
        const minutes \= now.getMinutes().toString().padStart(2, '0');

        fechaInput.value \= \`${year}-${month}-${day}T${hours}:${minutes}\`;  
    }

    // \--- 2\. Llenar campo Base y Quote basado en Par (Corregido para usar '/') \---  
    const parInput \= document.getElementById('par');  
    const baseInput \= document.getElementById('base');  
    const quoteInput \= document.getElementById('quote'); // Necesitamos este input para actualizarlo tambi√©n

    if (parInput && baseInput && quoteInput) {  
        parInput.addEventListener('input', function() {  
            const parValue \= parInput.value.trim().toUpperCase(); // Convertir a may√∫sculas  
            const slashIndex \= parValue.indexOf('/'); // Buscar la posici√≥n del '/'

            // Verificar si se encontr√≥ el '/' y si hay texto antes y despu√©s de √©l  
            if (slashIndex \> 0 && slashIndex \< parValue.length \- 1\) {  
                // Si se encontr√≥ el '/' y no est√° ni al principio ni al final  
                const baseValue \= parValue.substring(0, slashIndex); // Parte antes del '/'  
                const quoteValue \= parValue.substring(slashIndex \+ 1); // Parte despu√©s del '/'

                baseInput.value \= baseValue;  
                quoteInput.value \= quoteValue; // Actualizamos tambi√©n el campo quote

            } else {  
                // Si no se encontr√≥ el '/' o el formato no es el esperado (ej: "BTC/", "/USDT", "BTCUSDT")  
                // Aqu√≠ puedes decidir qu√© hacer. Una opci√≥n es intentar la l√≥gica anterior (sin slash)  
                // si quieres soportar ambos formatos (con o sin slash).  
                // Otra opci√≥n es simplemente dejar los campos base y quote vac√≠os, forzando al usuario  
                // a usar el formato con slash para la auto-detecci√≥n.  
                // Optaremos por dejar vac√≠os si el formato slash es incorrecto o no est√° presente,  
                // y si el quote es USDT, intentamos la l√≥gica anterior como fallback.

                const quoteDefaultValue \= 'USDT'; // Valor por defecto o el que esperas sin slash  
                const quoteValue \= quoteInput.value.trim().toUpperCase(); // Valor actual del campo quote

                 if (parValue.endsWith(quoteValue) && parValue.length \> quoteValue.length) {  
                     // L√≥gica original: quitar el quote del final si termina con √©l  
                     const baseValue \= parValue.substring(0, parValue.length \- quoteValue.length);  
                     baseInput.value \= baseValue;  
                     // No cambiamos quoteInput.value aqu√≠, ya que la l√≥gica se basa en que el par termina en el quote actual  
                     // Podr√≠as a√±adir una comprobaci√≥n m√°s estricta si quieres.  
                 } else if (parValue.endsWith(quoteDefaultValue) && parValue.length \> quoteDefaultValue.length) {  
                     // Fallback si el par termina en el quote DEFAULT (USDT) aunque el campo quote cambie  
                     const baseValue \= parValue.substring(0, parValue.length \- quoteDefaultValue.length);  
                     baseInput.value \= baseValue;  
                     quoteInput.value \= quoteDefaultValue; // Aseguramos que quote sea USDT en este caso  
                 }  
                 else {  
                    // Si ninguno de los formatos coincide, dejar vac√≠os  
                    baseInput.value \= '';  
                    quoteInput.value \= '';  
                 }  
            }  
        });  
    }

    // \--- 3\. Calcular Total basado en Precio y Cantidad \---  
    const precioInput \= document.getElementById('precio');  
    const cantidadInput \= document.getElementById('cantidad');  
    const totalInput \= document.getElementById('total');

    if (precioInput && cantidadInput && totalInput) {  
        // Funci√≥n para calcular y actualizar el total  
        const calcularTotal \= function() {  
            const precio \= parseFloat(precioInput.value);  
            const cantidad \= parseFloat(cantidadInput.value);

            // Verificar si ambos valores son n√∫meros v√°lidos  
            if (\!isNaN(precio) && \!isNaN(cantidad)) {  
                const total \= precio \* cantidad;  
                // Considera redondear aqu√≠ si quieres precisi√≥n en la interfaz antes de enviar  
                // totalInput.value \= total.toFixed(8); // Ejemplo a 8 decimales  
                totalInput.value \= total;  
            } else {  
                // Si alguno no es un n√∫mero, dejar el total vac√≠o o 0  
                totalInput.value \= ''; // O 0, dependiendo de la preferencia  
            }  
        };

        // Agregar listeners para que el c√°lculo ocurra cada vez que cambien precio o cantidad  
        precioInput.addEventListener('input', calcularTotal);  
        cantidadInput.addEventListener('input', calcularTotal);  
    }

    // \--- 4\. y 5\. Fee y Moneda del Fee ya est√°n predeterminados en el HTML \---  
    // No se necesita c√≥digo JS adicional a menos que quisieras hacer algo din√°mico con ellos.  
    // Solo como ejemplo, puedes verificar que los valores est√©n cargados al inicio:  
    // const feeInput \= document.getElementById('fee');  
    // const monedaFeeInput \= document.getElementById('moneda\_fee');  
    // if (feeInput && \!feeInput.value) feeInput.value \= '0.00001969';  
    // if (monedaFeeInput && \!monedaFeeInput.value) monedaFeeInput.value \= 'BNB';  
    // Esto no es necesario si ya los pones en el HTML con el atributo value.  
});

\`\`\`

### **`style.css`**

\`\`\`css

body {  
    font-family: Arial, sans-serif;  
    background: \#f3f6fa;  
    padding: 20px;  
    max-width: 600px;  
    margin: auto; /\* Centra el contenido \*/  
}

h1 {  
    color: \#333;  
    text-align: center;  
    margin-bottom: 20px; /\* Espacio debajo del t√≠tulo \*/  
}

form {  
    background: white;  
    padding: 20px;  
    border-radius: 8px;  
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);  
    display: flex; /\* Usa flexbox para organizar los labels \*/  
    flex-direction: column; /\* Apila los labels verticalmente \*/  
}

label {  
    display: block; /\* Asegura que cada label ocupe su propia l√≠nea \*/  
    margin-bottom: 15px; /\* Espacio entre labels \*/  
    font-weight: bold;  
}

/\* Estilo para inputs y selects dentro de labels \*/  
label input:not(\[type="checkbox"\]),  
label select {  
    display: block; /\* Hace que el input/select ocupe el ancho disponible bajo el label \*/  
    width: 100%; /\* Ocupa el 100% del ancho de su contenedor (el label) \*/  
    padding: 10px; /\* Aumenta el padding \*/  
    margin-top: 5px; /\* Espacio entre el texto del label y el input \*/  
    margin-bottom: 0; /\* Elimina el margin-bottom del input para que el label controle el espacio \*/  
    border-radius: 4px;  
    border: 1px solid \#ccc;  
    box-sizing: border-box; /\* Incluye padding y border en el ancho total \*/  
    font-size: 1rem; /\* Tama√±o de fuente legible \*/  
}

/\* Estilo espec√≠fico para grupos de inputs en la misma l√≠nea si los hay (ajustar si tu HTML cambia) \*/  
/\* Actualmente, todos son 'display: block', as√≠ que esto puede no ser necesario \*/  
/\*  
label.inline-group input {  
    width: auto;  
    margin-right: 10px;  
    display: inline-block;  
}  
\*/

button {  
    width: 100%;  
    padding: 12px; /\* Aumenta el padding del bot√≥n \*/  
    background: \#2d89ef;  
    color: white;  
    border: none;  
    border-radius: 5px;  
    font-size: 1rem; /\* Tama√±o de fuente legible \*/  
    cursor: pointer; /\* Indica que es clickeable \*/  
    transition: background-color 0.3s ease; /\* Transici√≥n suave al pasar el mouse \*/  
    margin-top: 10px; /\* Espacio encima del bot√≥n \*/  
}

button:hover {  
    background: \#1b5fbf; /\* Color m√°s oscuro al pasar el mouse \*/  
}

/\* Estilo para el mensaje de √©xito/error \*/  
.success-message {  
    color: green;  
    font-weight: bold;  
    margin-bottom: 15px; /\* Espacio debajo del mensaje \*/  
    text-align: center; /\* Centra el texto \*/  
    padding: 10px;  
    background-color: \#e9ffeb; /\* Fondo suave \*/  
    border: 1px solid \#d0e9c6;  
    border-radius: 4px;  
}

.error-message {  
     color: red;  
     font-weight: bold;  
     margin-bottom: 15px;  
     text-align: center;  
     padding: 10px;  
     background-color: \#ffebeb;  
     border: 1px solid \#e9d0d0;  
     border-radius: 4px;  
}

\`\`\`  
Nota: A√±ad√≠ algunos comentarios y peque√±os ajustes al CSS para mejorar la legibilidad y el espaciado, adem√°s de clases `.success-message` y `.error-message` por si decides estilizarlos.

## **Base de Datos \- Estructura de la Tabla `operaciones`**

Aqu√≠ est√° la estructura de la tabla `operaciones` en MariaDB/MySQL:

\`\`\`sql

DESC operaciones;  
\+------------+--------------+------+-----+---------+----------------+  
| Field      | Type         | Null | Key | Default | Extra          |  
\+------------+--------------+------+-----+---------+----------------+  
| id         | int          | NO   | PRI | NULL    | auto\_increment |  
| fecha      | text         | YES  |     | NULL    |                |  
| par        | varchar(255) | YES  |     | NULL    |                |  
| base       | varchar(255) | YES  |     | NULL    |                |  
| quote      | varchar(255) | YES  |     | NULL    |                |  
| tipo       | varchar(255) | YES  |     | NULL    |                |  
| precio     | double       | YES  |     | NULL    |                |  
| cantidad   | double       | YES  |     | NULL    |                |  
| total      | double       | YES  |     | NULL    |                |  
| fee        | double       | YES  |     | NULL    |                |  
| moneda\_fee | varchar(255) | YES  |     | NULL    |                |  
\+------------+--------------+------+-----+---------+----------------+  
\`\`\`

¬°Excelente\! Me parece una gran idea documentar este proyecto colaborativo en un archivo README.md. Ser√° muy √∫til para ti como referencia y para compartir si alguien m√°s quiere aprender o utilizarlo.

Aqu√≠ tienes el contenido completo para tu archivo `README.md`, incluyendo la estructura del proyecto, el c√≥digo de cada archivo, la configuraci√≥n de la base de datos y la funci√≥n almacenada, as√≠ como el documento sobre Stored Procedures y Prepared Statements.

Markdown  
\# Proyecto Simple de Registro de Operaciones Crypto en PHP y MariaDB

Este proyecto es un ejemplo b√°sico de una aplicaci√≥n web sencilla para registrar operaciones de compra y venta de criptomonedas a trav√©s de un formulario HTML/PHP, almacenando los datos en una base de datos MariaDB/MySQL. Utiliza JavaScript para interactividad en el formulario y demuestra el uso de funciones almacenadas en la base de datos.

\#\# Caracter√≠sticas

\* Formulario web para ingreso de operaciones (Fecha, Par, Tipo, Precio, Cantidad, Fee, Moneda del Fee).  
\* Auto-llenado de Fecha/Hora actual en el formulario.  
\* Auto-llenado de los campos "Base" y "Quote" basado en el campo "Par" (soporta formatos \`BASE/QUOTE\` y \`BASEQUOTE\` si el quote es USDT por defecto).  
\* C√°lculo autom√°tico del "Total" (Precio \\\* Cantidad) en el formulario.  
\* Almacenamiento de datos en una tabla \`operaciones\` en MariaDB/MySQL.  
\* Uso de sentencias preparadas en PHP para una inserci√≥n segura en la base de datos.  
\* Mensaje de confirmaci√≥n de registro exitoso al enviar el formulario.  
\* Configuraci√≥n de conexi√≥n a base de datos externa.  
\* Ejemplo de uso de una Funci√≥n Almacenada para calcular el balance de una divisa.

\#\# Requisitos

\* Servidor Web (como Apache o Nginx) con soporte para PHP.  
\* PHP (versi√≥n 5.6 o superior recomendada, compatible con \`mysqli\`).  
\* Servidor de Base de Datos MariaDB o MySQL.

\#\# Estructura del Proyecto

La estructura de archivos del proyecto es la siguiente:

/tu\_proyecto/ ‚îú‚îÄ‚îÄ index.php \# Archivo principal con el formulario HTML y l√≥gica PHP para mostrar mensajes. ‚îú‚îÄ‚îÄ procesar.php \# Archivo PHP para procesar los datos del formulario e insertar en la DB. ‚îú‚îÄ‚îÄ script.js \# Archivo JavaScript para la interactividad del formulario (fechas, c√°lculo, parsing de par). ‚îú‚îÄ‚îÄ style.css \# Archivo CSS para dar estilos b√°sicos al formulario. ‚îî‚îÄ‚îÄ config.php \# Archivo PHP con la configuraci√≥n de conexi√≥n a la base de datos.

\#\# Configuraci√≥n y Puesta en Marcha

\#\#\# 1\. Configuraci√≥n de la Base de Datos MariaDB/MySQL

Primero, necesitas crear la base de datos y la tabla \`operaciones\`. Con√©ctate a tu servidor MariaDB/MySQL (usando la l√≠nea de comandos \`mysql\` o una herramienta gr√°fica como phpMyAdmin, Adminer, DBeaver, etc.) y ejecuta las siguientes sentencias SQL:

\`\`\`sql  
\-- Crear la base de datos (si no existe)  
CREATE DATABASE IF NOT EXISTS Bichance;

\-- Usar la base de datos  
USE Bichance;

\-- Crear la tabla 'operaciones'  
CREATE TABLE IF NOT EXISTS operaciones (  
    id INT AUTO\_INCREMENT PRIMARY KEY,  
    fecha TEXT, \-- Considerar cambiar a DATETIME o TIMESTAMP en un proyecto m√°s robusto  
    par VARCHAR(255),  
    base VARCHAR(255),  
    quote VARCHAR(255),  
    tipo VARCHAR(255), \-- BUY o SELL  
    precio DOUBLE,  
    cantidad DOUBLE,  
    total DOUBLE,  
    fee DOUBLE,  
    moneda\_fee VARCHAR(255)  
);

\-- Opcional pero recomendado para mejorar el rendimiento en consultas por 'base' o 'tipo'  
CREATE INDEX idx\_operaciones\_base ON operaciones (base);  
CREATE INDEX idx\_operaciones\_tipo ON operaciones (tipo);  
\-- Si consultas mucho por base Y tipo, un √≠ndice compuesto podr√≠a ser √∫til  
\-- CREATE INDEX idx\_operaciones\_base\_tipo ON operaciones (base, tipo);

**Nota sobre Permisos de Creaci√≥n:**

La creaci√≥n de la base de datos, tablas, √≠ndices y funciones almacenadas requiere permisos suficientes en el servidor MariaDB/MySQL. T√≠picamente, el usuario `root` tiene estos permisos. Si usas otro usuario, aseg√∫rate de que tenga los privilegios `CREATE DATABASE`, `CREATE TABLE`, `CREATE INDEX`, `CREATE ROUTINE`, etc., sobre la base de datos `Bichance`.

### **2\. Configuraci√≥n de Conexi√≥n (`config.php`)**

Edita el archivo `config.php` con los detalles de tu conexi√≥n a la base de datos:

PHP  
\<?php  
$host \= 'localhost'; // O la IP/nombre del servidor de la DB  
$user \= 'pablo';     // Tu usuario de base de datos  
$password \= 'usuario'; // Tu contrase√±a de base de datos  
$database \= 'Bichance'; // El nombre de la base de datos que creaste

$conn \= @new mysqli($host, $user, $password, $database);

// Verificar errores de conexi√≥n  
if ($conn-\>connect\_error) {  
    // En un entorno de producci√≥n, es mejor no mostrar detalles del error al usuario final  
    die('‚ùå Conexi√≥n fallida: (' . $conn-\>connect\_errno . ') ' . $conn-\>connect\_error);  
} else {  
    // Opcional: para verificar conexi√≥n exitosa (comentar o eliminar en producci√≥n)  
    // echo '‚úÖ Conexi√≥n exitosa a la base de datos.';  
}  
?\>

Reemplaza `'localhost'`, `'pablo'`, `'usuario'` y `'Bichance'` con tus datos de conexi√≥n.

### **3\. Archivos del Proyecto**

Coloca los archivos `index.php`, `procesar.php`, `script.js`, `style.css` y `config.php` dentro de un directorio en tu servidor web (por ejemplo, `htdocs/bichance/` si usas XAMPP/Apache).

### **4\. Crear la Funci√≥n Almacenada (Opcional pero Recomendado)**

Como discutimos, una forma √∫til de consultar el balance de una divisa es usando una funci√≥n almacenada. Puedes crearla ejecutando el siguiente c√≥digo SQL en tu base de datos `Bichance`:

SQL  
USE Bichance;

DELIMITER $$ \-- Cambiamos el delimitador temporalmente

CREATE FUNCTION calcular\_balance\_divisa (divisa\_base VARCHAR(255))  
RETURNS DOUBLE \-- Indicamos que la funci√≥n devolver√° un valor de tipo DOUBLE  
READS SQL DATA \-- Indica que la funci√≥n solo lee datos de las tablas  
BEGIN  
    DECLARE balance DOUBLE; \-- Declaramos una variable para almacenar el resultado

    \-- Calculamos la suma condicional (BUYs positivos, SELLs negativos)  
    SELECT SUM(case when tipo \= 'BUY' THEN cantidad when tipo \= 'SELL' THEN \-cantidad else 0 END)  
    INTO balance \-- Guardamos el resultado de la suma en la variable 'balance'  
    FROM operaciones  
    WHERE base \= divisa\_base; \-- Filtramos por la divisa\_base que recibimos como par√°metro

    RETURN balance; \-- Devolvemos el valor calculado  
END$$

DELIMITER ; \-- Restauramos el delimitador original

Una vez creada, puedes consultar el balance de una divisa (ej: BCH) ejecutando `SELECT calcular_balance_divisa('BCH');` en tu cliente SQL.

## **Uso**

1. Abre tu navegador web y navega a la URL donde desplegaste el proyecto (ej: `http://localhost/bichance/` o `http://tu_dominio/bichance/`).  
2. Ver√°s el formulario de registro de operaciones.  
3. Llena los campos. Al ingresar el "Par" (ej: `ETH/USDT`), los campos "Base" (ETH) y "Quote" (USDT) se auto-llenar√°n. Al ingresar "Precio" y "Cantidad", el campo "Total" se calcular√° autom√°ticamente.  
4. Haz clic en el bot√≥n "Registrar".  
5. Si la operaci√≥n se registra con √©xito, ser√°s redirigido a `index.php` y ver√°s el mensaje de √©xito en la parte superior de la p√°gina. Si falla, ver√°s un mensaje de error.

## **C√≥digo de los Archivos**

Aqu√≠ se incluye el c√≥digo completo de cada archivo del proyecto para referencia:

### **`index.php`**

PHP  
\<\!DOCTYPE html\>  
\<html lang="es"\>  
\<head\>  
    \<meta charset="UTF-8"\>  
    \<meta name="viewport" content="width=device-width, initial-scale=1.0"\>  
    \<title\>Registrar Operaci√≥n\</title\>  
    \<link rel="stylesheet" href="style.css"\>  
    \<script src="script.js" defer\>\</script\>  
\</head\>  
\<body\>  
    \<h1\>Ingreso de Operaci√≥n Crypto\</h1\>

    \<?php  
    // Verifica si el par√°metro 'mensaje' existe en la URL y si su valor es 'ok'  
    if (isset($\_GET\['mensaje'\]) && $\_GET\['mensaje'\] \== 'ok') {  
    ?\>  
        \<div style="color: green; font-weight: bold; margin-bottom: 10px;"\>  
            ‚úÖ Operaci√≥n registrada con √©xito  
        \</div\>  
    \<?php  
    }  
    // Si quisieras mostrar errores pasados por URL, podr√≠as a√±adir otro 'if' aqu√≠:  
    // if (isset($\_GET\['mensaje'\]) && $\_GET\['mensaje'\] \== 'error') { ... }  
    ?\>

    \<form action="procesar.php" method="post" id="formularioOperacion"\>  
        \<label\>Fecha: \<input type="datetime-local" name="fecha" id="fecha" required\>\</label\>

        \<label\>Par: \<input type="text" name="par" id="par" required placeholder="Ej: BTC/USDT o BTCUSDT"\>\</label\>

        \<label\>Base: \<input type="text" name="base" id="base" required readonly\>\</label\>  
        \<label\>Quote: \<input type="text" name="quote" id="quote" value="USDT" required readonly\>\</label\>

        \<label\>Tipo:  
            \<select name="tipo" id="tipo" required\>  
                \<option value="BUY"\>Compra\</option\>  
                \<option value="SELL"\>Venta\</option\>  
            \</select\>  
        \</label\>

        \<label\>Precio: \<input type="number" step="0.00000001" name="precio" id="precio" required\>\</label\>  
        \<label\>Cantidad: \<input type="number" step="0.00000001" name="cantidad" id="cantidad" required\>\</label\>

        \<label\>Total: \<input type="number" step="0.00000001" name="total" id="total" required readonly\>\</label\>  
        \<label\>Fee: \<input type="number" step="0.00000001" name="fee" id="fee" value="0.00001969" required\>\</label\>

        \<label\>Moneda del Fee: \<input type="text" name="moneda\_fee" id="moneda\_fee" value="BNB" required readonly\>\</label\>  
        \<button type="submit"\>Registrar\</button\>  
    \</form\>

    \<div id="messages"\>\</div\>

\</body\>  
\</html\>

### **`procesar.php`**

PHP  
\<?php  
require 'config.php';

// Funci√≥n para limpiar y escapar datos (b√°sico, considera usar m√°s robustos si es necesario)  
function limpiar($valor) {  
    // Elimina espacios al inicio y final, y convierte caracteres especiales a entidades HTML  
    return htmlspecialchars(trim($valor));  
}

$campos \= \['fecha', 'par', 'base', 'quote', 'tipo', 'precio', 'cantidad', 'total', 'fee', 'moneda\_fee'\];  
$datos \= \[\];

// Validar y limpiar campos POST  
foreach ($campos as $campo) {  
    if (\!isset($\_POST\[$campo\]) || $\_POST\[$campo\] \=== '') {  
        // Si falta alg√∫n campo, muestra un error y detiene la ejecuci√≥n  
        die("Error: Falta completar el campo: " . htmlspecialchars($campo));  
    }  
    $datos\[$campo\] \= limpiar($\_POST\[$campo\]);  
}

// üîÅ Correcci√≥n de formato de fecha si viene de input\[type="datetime-local"\] (reemplaza 'T' por un espacio)  
$datos\['fecha'\] \= str\_replace('T', ' ', $datos\['fecha'\]);

// üîÅ Redondear valores num√©ricos a una precisi√≥n adecuada antes de insertar  
// Esto ayuda a evitar problemas de precisi√≥n flotante en la base de datos y al mostrar  
// Se usan floatval() para asegurar que los datos sean tratados como n√∫meros  
$datos\['precio'\] \= round(floatval($datos\['precio'\]), 8); // Usar una precisi√≥n mayor para precios/cantidades  
$datos\['cantidad'\] \= round(floatval($datos\['cantidad'\]), 8);  
$datos\['total'\] \= round(floatval($datos\['total'\]), 8);  
$datos\['fee'\] \= round(floatval($datos\['fee'\]), 8);

// Preparar la sentencia SQL para insertar datos  
// Se usan placeholders (?) para prevenir inyecciones SQL  
$stmt \= $conn-\>prepare("INSERT INTO operaciones (fecha, par, base, quote, tipo, precio, cantidad, total, fee, moneda\_fee)  
                         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");

// Verificar si la preparaci√≥n de la sentencia fue exitosa  
if ($stmt \=== false) {  
    // Muestra un error si la preparaci√≥n falla  
    die("Error en la preparaci√≥n de la sentencia: " . $conn-\>error);  
}

// Vincular los par√°metros con los valores limpios de los datos POST  
// La cadena "sssssdddds" especifica los tipos de datos de los par√°metros:  
// s \= string, d \= double (o float/decimal), i \= integer, b \= blob  
$stmt-\>bind\_param("ssssddddds",  
    $datos\['fecha'\],  
    $datos\['par'\],  
    $datos\['base'\],  
    $datos\['quote'\],  
    $datos\['tipo'\],  
    $datos\['precio'\],  
    $datos\['cantidad'\],  
    $datos\['total'\],  
    $datos\['fee'\],  
    $datos\['moneda\_fee'\]  
);

// Ejecutar la sentencia preparada  
if ($stmt-\>execute()) {  
    // Si la ejecuci√≥n es exitosa, redirigir a index.php con un mensaje de √©xito  
    // El par√°metro 'mensaje=ok' ser√° le√≠do por index.php  
    header("Location: index.php?mensaje=ok");  
    exit(); // Importante terminar el script despu√©s de una redirecci√≥n  
} else {  
    // Si la ejecuci√≥n falla, muestra un mensaje de error  
    // Considera redirigir tambi√©n con un par√°metro de error para consistencia  
    echo "\<h2\>‚ùå Error al insertar la operaci√≥n: " . $stmt-\>error . "\</h2\>";  
    // Opcional: Redirigir con error \-\> header("Location: index.php?mensaje=error\&detalle=" . urlencode($stmt-\>error)); exit();  
}

// Cerrar la sentencia y la conexi√≥n a la base de datos  
$stmt-\>close();  
$conn-\>close();  
?\>

*Nota: He a√±adido `round(floatval(...), 8)` a los campos num√©ricos en `procesar.php` para manejar mejor la precisi√≥n de los puntos flotantes antes de la inserci√≥n, lo cual es una buena pr√°ctica.*

### **`script.js`**

JavaScript  
document.addEventListener('DOMContentLoaded', function() {  
    // \--- 1\. Establecer la fecha y hora actual \---  
    const fechaInput \= document.getElementById('fecha');  
    if (fechaInput) {  
        const now \= new Date();  
        // Formato\<ctrl97\>-MM-DDTHH:MM requerido por input type="datetime-local"  
        const year \= now.getFullYear();  
        const month \= (now.getMonth() \+ 1).toString().padStart(2, '0'); // getMonth() es base 0  
        const day \= now.getDate().toString().padStart(2, '0');  
        const hours \= now.getHours().toString().padStart(2, '0');  
        const minutes \= now.getMinutes().toString().padStart(2, '0');

        fechaInput.value \= \`${year}-${month}-${day}T${hours}:${minutes}\`;  
    }

    // \--- 2\. Llenar campo Base y Quote basado en Par (Corregido para usar '/') \---  
    const parInput \= document.getElementById('par');  
    const baseInput \= document.getElementById('base');  
    const quoteInput \= document.getElementById('quote'); // Necesitamos este input para actualizarlo tambi√©n

    if (parInput && baseInput && quoteInput) {  
        parInput.addEventListener('input', function() {  
            const parValue \= parInput.value.trim().toUpperCase(); // Convertir a may√∫sculas  
            const slashIndex \= parValue.indexOf('/'); // Buscar la posici√≥n del '/'

            // Verificar si se encontr√≥ el '/' y si hay texto antes y despu√©s de √©l  
            if (slashIndex \> 0 && slashIndex \< parValue.length \- 1\) {  
                // Si se encontr√≥ el '/' y no est√° ni al principio ni al final  
                const baseValue \= parValue.substring(0, slashIndex); // Parte antes del '/'  
                const quoteValue \= parValue.substring(slashIndex \+ 1); // Parte despu√©s del '/'

                baseInput.value \= baseValue;  
                quoteInput.value \= quoteValue; // Actualizamos tambi√©n el campo quote

            } else {  
                // Si no se encontr√≥ el '/' o el formato no es el esperado (ej: "BTC/", "/USDT", "BTCUSDT")  
                // Aqu√≠ puedes decidir qu√© hacer. Una opci√≥n es intentar la l√≥gica anterior (sin slash)  
                // si quieres soportar ambos formatos (con o sin slash).  
                // Otra opci√≥n es simplemente dejar los campos base y quote vac√≠os, forzando al usuario  
                // a usar el formato con slash para la auto-detecci√≥n.  
                // Optaremos por dejar vac√≠os si el formato slash es incorrecto o no est√° presente,  
                // y si el quote es USDT, intentamos la l√≥gica anterior como fallback.

                const quoteDefaultValue \= 'USDT'; // Valor por defecto o el que esperas sin slash  
                const quoteValue \= quoteInput.value.trim().toUpperCase(); // Valor actual del campo quote

                 if (parValue.endsWith(quoteValue) && parValue.length \> quoteValue.length) {  
                     // L√≥gica original: quitar el quote del final si termina con √©l  
                     const baseValue \= parValue.substring(0, parValue.length \- quoteValue.length);  
                     baseInput.value \= baseValue;  
                     // No cambiamos quoteInput.value aqu√≠, ya que la l√≥gica se basa en que el par termina en el quote actual  
                     // Podr√≠as a√±adir una comprobaci√≥n m√°s estricta si quieres.  
                 } else if (parValue.endsWith(quoteDefaultValue) && parValue.length \> quoteDefaultValue.length) {  
                     // Fallback si el par termina en el quote DEFAULT (USDT) aunque el campo quote cambie  
                     const baseValue \= parValue.substring(0, parValue.length \- quoteDefaultValue.length);  
                     baseInput.value \= baseValue;  
                     quoteInput.value \= quoteDefaultValue; // Aseguramos que quote sea USDT en este caso  
                 }  
                 else {  
                    // Si ninguno de los formatos coincide, dejar vac√≠os  
                    baseInput.value \= '';  
                    quoteInput.value \= '';  
                 }  
            }  
        });  
    }

    // \--- 3\. Calcular Total basado en Precio y Cantidad \---  
    const precioInput \= document.getElementById('precio');  
    const cantidadInput \= document.getElementById('cantidad');  
    const totalInput \= document.getElementById('total');

    if (precioInput && cantidadInput && totalInput) {  
        // Funci√≥n para calcular y actualizar el total  
        const calcularTotal \= function() {  
            const precio \= parseFloat(precioInput.value);  
            const cantidad \= parseFloat(cantidadInput.value);

            // Verificar si ambos valores son n√∫meros v√°lidos  
            if (\!isNaN(precio) && \!isNaN(cantidad)) {  
                const total \= precio \* cantidad;  
                // Considera redondear aqu√≠ si quieres precisi√≥n en la interfaz antes de enviar  
                // totalInput.value \= total.toFixed(8); // Ejemplo a 8 decimales  
                totalInput.value \= total;  
            } else {  
                // Si alguno no es un n√∫mero, dejar el total vac√≠o o 0  
                totalInput.value \= ''; // O 0, dependiendo de la preferencia  
            }  
        };

        // Agregar listeners para que el c√°lculo ocurra cada vez que cambien precio o cantidad  
        precioInput.addEventListener('input', calcularTotal);  
        cantidadInput.addEventListener('input', calcularTotal);  
    }

    // \--- 4\. y 5\. Fee y Moneda del Fee ya est√°n predeterminados en el HTML \---  
    // No se necesita c√≥digo JS adicional a menos que quisieras hacer algo din√°mico con ellos.  
    // Solo como ejemplo, puedes verificar que los valores est√©n cargados al inicio:  
    // const feeInput \= document.getElementById('fee');  
    // const monedaFeeInput \= document.getElementById('moneda\_fee');  
    // if (feeInput && \!feeInput.value) feeInput.value \= '0.00001969';  
    // if (monedaFeeInput && \!monedaFeeInput.value) monedaFeeInput.value \= 'BNB';  
    // Esto no es necesario si ya los pones en el HTML con el atributo value.  
});

### **`style.css`**

CSS  
body {  
    font-family: Arial, sans-serif;  
    background: \#f3f6fa;  
    padding: 20px;  
    max-width: 600px;  
    margin: auto; /\* Centra el contenido \*/  
}

h1 {  
    color: \#333;  
    text-align: center;  
    margin-bottom: 20px; /\* Espacio debajo del t√≠tulo \*/  
}

form {  
    background: white;  
    padding: 20px;  
    border-radius: 8px;  
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);  
    display: flex; /\* Usa flexbox para organizar los labels \*/  
    flex-direction: column; /\* Apila los labels verticalmente \*/  
}

label {  
    display: block; /\* Asegura que cada label ocupe su propia l√≠nea \*/  
    margin-bottom: 15px; /\* Espacio entre labels \*/  
    font-weight: bold;  
}

/\* Estilo para inputs y selects dentro de labels \*/  
label input:not(\[type="checkbox"\]),  
label select {  
    display: block; /\* Hace que el input/select ocupe el ancho disponible bajo el label \*/  
    width: 100%; /\* Ocupa el 100% del ancho de su contenedor (el label) \*/  
    padding: 10px; /\* Aumenta el padding \*/  
    margin-top: 5px; /\* Espacio entre el texto del label y el input \*/  
    margin-bottom: 0; /\* Elimina el margin-bottom del input para que el label controle el espacio \*/  
    border-radius: 4px;  
    border: 1px solid \#ccc;  
    box-sizing: border-box; /\* Incluye padding y border en el ancho total \*/  
    font-size: 1rem; /\* Tama√±o de fuente legible \*/  
}

/\* Estilo espec√≠fico para grupos de inputs en la misma l√≠nea si los hay (ajustar si tu HTML cambia) \*/  
/\* Actualmente, todos son 'display: block', as√≠ que esto puede no ser necesario \*/  
/\*  
label.inline-group input {  
    width: auto;  
    margin-right: 10px;  
    display: inline-block;  
}  
\*/

button {  
    width: 100%;  
    padding: 12px; /\* Aumenta el padding del bot√≥n \*/  
    background: \#2d89ef;  
    color: white;  
    border: none;  
    border-radius: 5px;  
    font-size: 1rem; /\* Tama√±o de fuente legible \*/  
    cursor: pointer; /\* Indica que es clickeable \*/  
    transition: background-color 0.3s ease; /\* Transici√≥n suave al pasar el mouse \*/  
    margin-top: 10px; /\* Espacio encima del bot√≥n \*/  
}

button:hover {  
    background: \#1b5fbf; /\* Color m√°s oscuro al pasar el mouse \*/  
}

/\* Estilo para el mensaje de √©xito/error \*/  
.success-message {  
    color: green;  
    font-weight: bold;  
    margin-bottom: 15px; /\* Espacio debajo del mensaje \*/  
    text-align: center; /\* Centra el texto \*/  
    padding: 10px;  
    background-color: \#e9ffeb; /\* Fondo suave \*/  
    border: 1px solid \#d0e9c6;  
    border-radius: 4px;  
}

.error-message {  
     color: red;  
     font-weight: bold;  
     margin-bottom: 15px;  
     text-align: center;  
     padding: 10px;  
     background-color: \#ffebeb;  
     border: 1px solid \#e9d0d0;  
     border-radius: 4px;  
}

*Nota: A√±ad√≠ algunos comentarios y peque√±os ajustes al CSS para mejorar la legibilidad y el espaciado, adem√°s de clases `.success-message` y `.error-message` por si decides estilizarlos.*

### **`config.php`**

(Ya proporcionado arriba en la secci√≥n de Configuraci√≥n)

## 

## 

## **Base de Datos \- Estructura de la Tabla `operaciones`**

Aqu√≠ est√° la estructura de la tabla `operaciones` en MariaDB/MySQL:

\`\`\`sql  
DESC operaciones;

\+------------+--------------+------+-----+---------+----------------+  
| Field      | Type         | Null | Key | Default | Extra          |  
\+------------+--------------+------+-----+---------+----------------+  
| id         | int          | NO   | PRI | NULL    | auto\_increment |  
| fecha      | text         | YES  |     | NULL    |                |  
| par        | varchar(255) | YES  |     | NULL    |                |  
| base       | varchar(255) | YES  |     | NULL    |                |  
| quote      | varchar(255) | YES  |     | NULL    |                |  
| tipo       | varchar(255) | YES  |     | NULL    |                |  
| precio     | double       | YES  |     | NULL    |                |  
| cantidad   | double       | YES  |     | NULL    |                |  
| total      | double       | YES  |     | NULL    |                |  
| fee        | double       | YES  |     | NULL    |                |  
| moneda\_fee | varchar(255) | YES  |     | NULL    |                |  
\+------------+--------------+------+-----+---------+----------------+  
\`\`\`

## **Documentaci√≥n Adicional: Stored Procedures y Prepared Statements**

Aqu√≠ se incluye el documento que generamos previamente explicando qu√© son los Stored Procedures, Stored Functions y Prepared Statements, sus ventajas y ejemplos.

### **\# Stored Procedures y Prepared Statements en MariaDB/SQL**

Este documento explica qu√© son los Stored Procedures y los Prepared Statements en el contexto de bases de datos SQL, enfoc√°ndose en su aplicaci√≥n en MariaDB (aunque los conceptos son generales para SQL), sus ventajas y ofrece ejemplos pr√°cticos.

#### **\#\# Introducci√≥n**

Tanto los Stored Procedures como los Prepared Statements son caracter√≠sticas poderosas en SQL que ayudan a mejorar el rendimiento, la seguridad y la mantenibilidad de las aplicaciones que interact√∫an con bases de datos. Aunque ambos involucran la ejecuci√≥n de c√≥digo SQL en el servidor, cumplen prop√≥sitos ligeramente diferentes y se usan en distintos escenarios.

#### **1\. Stored Procedures (Procedimientos Almacenados)**

##### **¬øQu√© son?**

Un Stored Procedure es un bloque de c√≥digo SQL que se compila y almacena en la base de datos del servidor. Esencialmente, es una subrutina o funci√≥n que puede ser llamada y ejecutada por aplicaciones cliente u otros procedimientos almacenados. Pueden aceptar par√°metros de entrada, devolver valores (a trav√©s de par√°metros de salida) y ejecutar m√∫ltiples sentencias SQL, incluyendo l√≥gica de control de flujo como IF, WHILE, cursores, etc.

##### **Ventajas**

* **Rendimiento:** Al estar pre-compilados en la base de datos, su ejecuci√≥n es m√°s r√°pida ya que no necesitan ser parseados y optimizados cada vez que se les llama. Esto tambi√©n reduce el tr√°fico de red, ya que solo se env√≠a el nombre del procedimiento y sus par√°metros, en lugar de todo el c√≥digo SQL.  
* **Modularidad y Reusabilidad:** Permiten encapsular l√≥gica de negocio compleja en un solo lugar, que puede ser reutilizada por m√∫ltiples aplicaciones o partes de una misma aplicaci√≥n.  
* **Seguridad:** Se pueden otorgar permisos de ejecuci√≥n a los usuarios o roles solo sobre el procedimiento almacenado, sin darles acceso directo a las tablas subyacentes. Esto limita la superficie de ataque y controla c√≥mo se manipulan los datos.  
* **Mantenimiento:** Al centralizar la l√≥gica en la base de datos, las actualizaciones o correcciones solo necesitan hacerse en un lugar (el procedimiento almacenado), en lugar de actualizar cada aplicaci√≥n cliente que use esa l√≥gica.

## **Base de Datos \- Funci√≥n Almacenada `calcular_balance_divisa`**

##### **Ejemplo Funci√≥n Almacenada para C√°lculo de Balance**

Esta funci√≥n almacena la l√≥gica para calcular el balance neto (compras \- ventas) de una divisa espec√≠fica. Su c√≥digo de creaci√≥n se encuentra en la secci√≥n de "Configuraci√≥n y Puesta en Marcha".

Una **Funci√≥n Almacenada (Stored Function)** es similar a un Stored Procedure, pero est√° dise√±ada para calcular y *devolver un √∫nico valor* escalar. Son ideales para usar directamente en consultas `SELECT` o dentro de otras sentencias SQL.

Aqu√≠ tienes la funci√≥n que calculamos para obtener el balance neto de una divisa espec√≠fica en tu tabla `operaciones`:

\`\`\`SQL

USE Bichance; \-- Aseg√∫rate de estar en la base de datos correcta

DELIMITER $$ \-- Cambiamos el delimitador temporalmente

CREATE FUNCTION calcular\_balance\_divisa (divisa\_base VARCHAR(255))

RETURNS DOUBLE \-- Indicamos que la funci√≥n devolver√° un valor de tipo DOUBLE

READS SQL DATA \-- Indica que la funci√≥n solo lee datos de las tablas

BEGIN

    DECLARE balance DOUBLE; \-- Declaramos una variable para almacenar el resultado

    \-- Calculamos la suma condicional (BUYs positivos, SELLs negativos)

    SELECT SUM(case when tipo \= 'BUY' THEN cantidad when tipo \= 'SELL' THEN \-cantidad else 0 END)

    INTO balance \-- Guardamos el resultado de la suma en la variable 'balance'

    FROM operaciones

    WHERE base \= divisa\_base; \-- Usamos el par√°metro de la funci√≥n

    RETURN balance; \-- Devolvemos el valor calculado

END$$

DELIMITER ; \-- Restaura el delimitador original

\`\`\`

**C√≥mo usar la Funci√≥n:**

Una vez creada, puedes llamar a esta funci√≥n directamente en tus consultas `SELECT`:

\`\`\`SQL  
\-- Para obtener el balance de BCH  
SELECT calcular\_balance\_divisa('BCH');  
\`\`\`

#### **Nota Importante: Permisos de Creaci√≥n**

Es fundamental tener en cuenta que la creaci√≥n de objetos de base de datos como Stored Procedures, Stored Functions y Views generalmente requiere permisos elevados.

T√≠picamente, el usuario `root` (el superusuario de la base de datos) tiene permisos para crear cualquier objeto. Sin embargo, en un entorno de producci√≥n o con una buena pol√≠tica de seguridad, no se suele usar `root` para tareas diarias.

Para crear Stored Procedures y Functions, un usuario necesita el privilegio `CREATE ROUTINE`. Para modificar o eliminar procedimientos y funciones existentes, necesita el privilegio `ALTER ROUTINE` o `DROP ROUTINE` respectivamente.

Para crear Views (como la que vimos como opci√≥n para el balance por divisa), se necesita el privilegio `CREATE VIEW`.

Por lo tanto, si no est√°s utilizando el usuario `root`, aseg√∫rate de que el usuario con el que intentas crear estos objetos tenga los permisos adecuados (`GRANT CREATE ROUTINE ON tu_base_de_datos.* TO 'tu_usuario'@'localhost';`, por ejemplo).

## **Contribuciones**

Este proyecto fue desarrollado de forma colaborativa. Si√©ntete libre de usarlo, modificarlo y mejorarlo!!

---

¬°Espero que este README.md te sea de gran utilidad\! 

